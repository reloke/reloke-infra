# üèóÔ∏è Backend NestJS ‚Äì Prisma ‚Äì PostgreSQL (Spatial / PostGIS)

Ce backend est bas√© sur :

* **Node.js : 24.11.1**
* **NestJS : 11.0.12**
* **Prisma ORM**
* **PostgreSQL**
* **PostGIS** (ajout manuel pour disposer des types spatiaux)
* Base g√©n√©r√©e depuis `schema.prisma` fourni ci-dessous

Ce README permet aux d√©veloppeurs de mettre √† jour leurs environnements, d‚Äôinstaller PostGIS en local et de transformer la base cr√©√©e par Prisma en base spatiale.

---

# üì¶ 1. Installation & Mise √† jour de l'environnement

## 1.1 Installer / v√©rifier Node.js (24.11.1)

V√©rifier votre version :

```
node -v
```

Si vous n‚Äôavez pas la bonne version :

### Avec NVM

```
nvm install 24.11.1
nvm use 24.11.1
```

### Ou via nodejs.org

[https://nodejs.org](https://nodejs.org)

---

## 1.2 Installer Nest CLI

```
npm i -g @nestjs/cli
```

V√©rifier :

```
nest --version
```

---

## 1.3 Installer les d√©pendances du projet

```
npm install
```

---

# üóÑÔ∏è 2. Base de donn√©es PostgreSQL + PostGIS

Ce projet n√©cessite PostgreSQL avec l‚Äôextension **PostGIS**. Vous pouvez installer PostgreSQL de plusieurs mani√®res.

---

## 2.1 Installation PostgreSQL

**Option 1 ‚Äì Classique (avec pgAdmin)**
T√©l√©chargement : [https://www.postgresql.org/download/](https://www.postgresql.org/download/)
Suivez les instructions pour votre OS (Windows / macOS / Linux).

**Option 2 ‚Äì StackBuilder (Windows / macOS)**
StackBuilder est fourni avec l‚Äôinstallateur PostgreSQL officiel. Il permet d‚Äôinstaller **PostGIS et d‚Äôautres extensions** facilement.

1. T√©l√©chargez PostgreSQL : [https://www.postgresql.org/download/](https://www.postgresql.org/download/)
2. Lors de l‚Äôinstallation, cochez **‚ÄúStackBuilder‚Äù** pour l‚Äôinstaller √©galement
3. Apr√®s l‚Äôinstallation, lancez StackBuilder
4. S√©lectionnez votre serveur PostgreSQL et cliquez sur **Next**
5. Dans la liste des extensions disponibles, s√©lectionnez :

   * `PostGIS`
   * `PostGIS Topology` (optionnel mais recommand√©)
6. Suivez l‚Äôassistant pour installer les extensions
7. Red√©marrez votre serveur PostgreSQL si n√©cessaire

---

## 2.2 Activation PostGIS dans la base

Apr√®s cr√©ation de la base via Prisma ou manuellement, activez PostGIS :

**Via psql :**

```sql
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS postgis_topology;
```

**Via pgAdmin :**

1. Ouvrir votre base
2. Aller dans **Extensions** ‚Üí Clic droit ‚Üí **Create**
3. S√©lectionner `postgis` et `postgis_topology`

‚úî Votre base est maintenant pr√™te pour g√©rer des types spatiaux.

---

# üß© 3. Configuration Prisma

## 3.1 Installation Prisma

```
npm install prisma --save-dev
npm install @prisma/client
```

## 3.2 G√©n√©ration du client

```
npx prisma generate
```

## 3.3 Cr√©ation ou mise √† jour de la base

```
   * old: npx prisma migrate dev
   * new: npm run migrate:geo
```

Ou si vous ne souhaitez pas g√©rer les migrations :

```
npx prisma db push
```

---

# üåç 4. Transformation de la BDD Prisma ‚Üí PostGIS

Prisma **ne supporte pas PostGIS**.
Les champs spatiaux doivent √™tre g√©r√©s **manuellement apr√®s la cr√©ation de la base**.

Dans ton `schema.prisma`, les champs spatiaux potentiels sont :

| Table            | Champs               | Type Prisma |
| ---------------- | -------------------- | ----------- |
| **Home**         | latitude / longitude | Float?      |
| **SearchAdress** | latitude / longitude | Float?      |

---

# üõ∞Ô∏è 5. Scripts SQL pour convertir la BDD en spatiale (PostGIS)

## 5.1 Conversion de la table **Home**

### Ajouter la colonne spatiale

```sql
ALTER TABLE "Home"
ADD COLUMN geom geometry(Point, 4326);
```

### Remplir geom √† partir latitude/longitude

```sql
UPDATE "Home"
SET geom = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)
WHERE longitude IS NOT NULL
  AND latitude IS NOT NULL;
```

### Supprimer les anciennes colonnes (optionnel)

```sql
ALTER TABLE "Home"
DROP COLUMN longitude,
DROP COLUMN latitude;
```

---

## 5.2 Conversion de la table **SearchAdress**

### Ajouter colonne g√©om√©trique

```sql
ALTER TABLE "SearchAdress"
ADD COLUMN geom geometry(Point, 4326);
```

### Remplir geom

```sql
UPDATE "SearchAdress"
SET geom = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)
WHERE longitude IS NOT NULL
  AND latitude IS NOT NULL;
```

### Supprimer latitude/longitude (optionnel)

```sql
ALTER TABLE "SearchAdress"
DROP COLUMN longitude,
DROP COLUMN latitude;
```

---

# üîÅ 6. Apr√®s chaque migration Prisma

Prisma peut recr√©er ou modifier des colonnes classiques ‚Äî mais **n‚Äôa pas de support PostGIS**.

* Recr√©ez les colonnes `geom` si n√©cessaire
* Re-remplissez `geom`
* Les scipts sont dans le folder `sql/spatial/` √† la racine du projet
* Pour ex√©cuter les scripts soit le faire 
    * sur pgAdmin
    * Via fichier les fichiers .sql puis depuis un terminal‚ÄØ:
        * Ajouter psql √† ton PATH (Windows)
          Localise le binaire psql.exe. Par d√©faut, il se trouve ici‚ÄØ:
         C:\Program Files\PostgreSQL\<version>\bin\psql.exe
         Copie le chemin du dossier bin (...PostgreSQL\<version>\bin\)
         Ouvre les Param√®tres syst√®me ‚Üí Variables d‚Äôenvironnement ‚Üí PATH
         Ajoute le chemin du dossier bin
         Red√©marre ton terminal VSCode et teste‚ÄØ:
         psql --version
        * ---
        * 1- psql -U ton_user -d nom_de_la_base -f addGeoColumns.sql 
        * 2- psql -U ton_user -d nom_de_la_base -f fillGeoColumns.sql 
        * ---


# ‚ñ∂Ô∏è 7. Lancer le projet

## Dev :

```
npm run start:dev
```

## Prod :

```
npm run build
npm run start:prod
```

---

# üß™ 8. Outils utiles

### Ouvrir Prisma Studio :

```
npx prisma studio
```

### V√©rifier le sch√©ma :

```
npx prisma validate
```

### R√©initialiser la base (‚ö† destructive) :

```
npx prisma migrate reset
```

---

# ü§ù 9. Workflow recommand√© pour les coll√®gues

1. Cloner le repo
2. Installer Node 24.11.1
3. Installer NestJS CLI
4. `npm install`
5. Configurer `.env`
6. Installer PostgreSQL + PostGIS (via StackBuilder ou pgAdmin/psql)
7. Cr√©er la base
8. Lancer Prisma :

   * `npx prisma generate`
   * `npx prisma migrate dev`
9. Ex√©cuter les scripts PostGIS :

   * Extensions
   * Colonnes `geom` pour Home & SearchAdress
10. Lancer API : `npm run start:dev`

---

# üóÉÔ∏è 10. R√©f√©rence du sch√©ma (schema.prisma)

*(Facultatif : tu peux l‚Äôajouter ici s'il doit appara√Ætre dans le README du repo.)*
