steps:
  # 1. Builder l'image Docker
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'europe-west9-docker.pkg.dev/$PROJECT_ID/reloke-repo/reloke-monolith', '.']

  # 2. Pousser l'image vers Artifact Registry (le nouveau garage)
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'europe-west9-docker.pkg.dev/$PROJECT_ID/reloke-repo/reloke-monolith']

  # 3. DÃ©ployer sur Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run', 'deploy', 'reloke-api',
        '--image', 'europe-west9-docker.pkg.dev/$PROJECT_ID/reloke-repo/reloke-monolith',
        '--region', 'europe-west9',
        '--platform', 'managed',
        '--allow-unauthenticated',
        '--min-instances', '1',
        '--cpu', '2',
        '--memory', '2Gi',
        '--timeout', '2400', 
        '--cpu-boost',
        '--set-env-vars', 'RUN_MIGRATIONS=false',
        #'--set-secrets', '/app/.env=reloke-env-back:latest',
        '--remove-secrets', '/app/.env'
      ]

options:
  logging: CLOUD_LOGGING_ONLY