<div class="min-h-screen bg-bg-main flex flex-col overflow-x-hidden" (click)="isProfileDropdownOpen = false">

  <!-- Top Navigation Bar -->
  <header
    class="bg-bg-main/20 backdrop-blur-sm sticky top-0 z-40 h-16 flex items-center px-4 sm:px-4 lg:px-4 justify-between border-b border-primary/30">
    <div class="flex items-center gap-3 w-20 justify-center">
      <button (click)="toggleSidebar(); $event.stopPropagation()"
        class="text-gray-600 hover:bg-gray-100 rounded-lg focus:outline-none transition-colors border border-transparent hover:border-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
    <div class="flex items-center gap-2 cursor-pointer group mr-auto" routerLink="/dashboard">
      <img src="assets/images/reloke.png" alt="Reloke"
        class="h-8 w-auto rotate-[-12deg] group-hover:rotate-0 transition-transform">
      <span class="text-xl font-bold text-primary font-canva hidden sm:block">{{ common.appName }}</span>
    </div>

    <div class="flex-1"></div>

    <!-- User Profile / Actions -->
    <div class="flex items-center gap-4 relative">


      <!-- Notifications Bell -->
      <div class="relative">
        <button (click)="toggleNotificationDropdown($event)"
          class="p-2 text-gray-400 hover:text-primary transition-all relative group" [@shake]="shakeState">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          <!-- Badge -->
          <span *ngIf="unreadCount > 0"
            class="absolute top-1.5 right-1.5 h-4 w-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center border-2 border-white scale-100 group-hover:scale-110 transition-transform">
            {{ unreadCount > 9 ? '9+' : unreadCount }}
          </span>
        </button>

        <!-- Notifications Dropdown -->
        <div *ngIf="isNotificationDropdownOpen"
          class="absolute right-0 top-full mt-2 w-80 bg-white rounded-2xl shadow-2xl border border-gray-100 py-0 z-50 animate-fade-in origin-top-right overflow-hidden flex flex-col max-h-[calc(100vh-120px)]">
          <div
            class="px-4 py-3 border-b border-gray-50 flex justify-between items-center bg-gray-50/50 sticky top-0 z-10 backdrop-blur-sm">
            <div class="flex flex-col">
              <h3 class="text-sm font-bold text-gray-900 leading-none mb-1">Notifications</h3>
              <button (click)="markAllRead($event)" *ngIf="unreadCount > 0"
                class="text-[10px] text-gray-400 hover:text-primary transition-colors text-left flex items-center gap-1">
                <i class="pi pi-check-circle text-[8px]"></i>
                Tout marquer comme lu
              </button>
            </div>
            <button (click)="requestPushPermission($event)" *ngIf="showPushActivationButton"
              class="flex items-center gap-1 px-2 py-1 rounded-lg bg-primary/5 text-primary text-[10px] font-bold hover:bg-primary/10 transition-all">
              ðŸš€ Activer Push
            </button>
          </div>

          <div class="overflow-y-auto custom-scrollbar flex-1">
            <div *ngIf="notifications.length === 0" class="px-4 py-8 text-center">
              <div class="h-12 w-12 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                </svg>
              </div>
              <p class="text-gray-400 text-sm">Aucune notification</p>
            </div>

            <div *ngFor="let n of notifications" (click)="onNotificationClick(n)"
              class="px-4 py-4 hover:bg-gray-50 cursor-pointer transition-all border-b border-gray-50 last:border-0 group/n"
              [ngClass]="{'bg-primary/5 active-notif': !n.isRead}">
              <div class="flex gap-4">
                <div
                  class="h-10 w-10 rounded-xl flex-shrink-0 flex items-center justify-center shadow-sm transition-transform group-hover/n:scale-110"
                  [ngClass]="{
                    'bg-blue-100 text-blue-600': n.type === 'MESSAGE',
                    'bg-green-100 text-green-600': n.type === 'MATCH',
                    'bg-gray-100 text-gray-600 border border-gray-200': n.type === 'SYSTEM'
                  }">
                  <svg *ngIf="n.type === 'MESSAGE'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                  </svg>
                  <svg *ngIf="n.type === 'MATCH'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                  <svg *ngIf="n.type === 'SYSTEM'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div class="flex-1 overflow-hidden">
                  <p
                    class="text-[13px] font-semibold text-gray-900 leading-snug group-hover/n:text-primary transition-colors">
                    {{ n.content }}</p>
                  <div class="flex items-center gap-2 mt-1.5">
                    <span class="text-[10px] font-medium px-2 py-0.5 rounded-full" [ngClass]="{
                        'bg-blue-50 text-blue-500': n.type === 'MESSAGE',
                        'bg-green-50 text-green-500': n.type === 'MATCH',
                        'bg-gray-50 text-gray-500': n.type === 'SYSTEM'
                      }">{{ n.type }}</span>
                    <span class="text-[10px] text-gray-400 font-medium">{{ n.createdAt | date:'shortTime' }}</span>
                  </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                  <div *ngIf="!n.isRead" class="h-2 w-2 bg-primary rounded-full"></div>
                  <button (click)="deleteNotification($event, n.id)"
                    class="p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg opacity-0 group-hover/n:opacity-100 transition-all"
                    title="Supprimer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24"
                      stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div
            class="px-2 py-3 border-t border-gray-50 bg-gray-50/50 text-center sticky bottom-0 z-10 backdrop-blur-sm">
            <button routerLink="/profile/notifications" (click)="isNotificationDropdownOpen = false"
              class="text-[11px] font-bold text-gray-400 hover:text-primary transition-colors">
              Historique complet
            </button>
          </div>
        </div>
      </div>

      <!-- Profile Dropdown Trigger -->
      <div *ngIf="currentUser as user" (click)="toggleProfileDropdown($event)"
        class="flex items-center gap-3 p-1 pr-3 hover:bg-gray-100 rounded-full transition-all cursor-pointer border-2 border-primary/30 group">
        <div
          class="h-9 w-9 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-sm border-2 border-white shadow-sm group-hover:border-primary/20 transition-all overflow-hidden">
          <img *ngIf="user.profilePicture" [src]="user.profilePicture" class="h-full w-full object-cover"
            [alt]="user.firstName">
          <span *ngIf="!user.profilePicture">{{ getInitials() }}</span>
        </div>
        <div class="hidden md:block text-left">
          <p class="text-sm font-semibold text-gray-800 leading-tight">{{ user.firstName }}</p>
          <p class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Mon compte</p>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-gray-400 group-hover:text-gray-600 transition-colors" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      <!-- Profile Dropdown Menu -->
      <div *ngIf="isProfileDropdownOpen"
        class="absolute right-0 top-full mt-2 w-56 bg-white rounded-2xl shadow-2xl border border-gray-100 py-2 z-[100] animate-fade-in origin-top-right">
        <div class="px-4 py-3 border-b border-gray-50">
          <p class="text-xs text-gray-400 uppercase tracking-widest font-bold mb-1">Utilisateur</p>
          <p class="text-sm font-bold text-gray-900 truncate">{{ currentUser?.mail }}</p>
        </div>

        <div class="p-1">
          <a routerLink="/profile/account" (click)="isProfileDropdownOpen = false"
            class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-gray-600 hover:text-primary hover:bg-primary/5 rounded-xl transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            Gestion du compte
          </a>

          <a routerLink="/profile/help" (click)="isProfileDropdownOpen = false"
            class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-gray-600 hover:text-primary hover:bg-primary/5 rounded-xl transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Aide
          </a>
        </div>

        <div class="h-px bg-gray-50 my-1"></div>

        <div class="p-1">
          <button (click)="openLogoutModal()"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            DÃ©connexion
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="flex flex-1 relative overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside
      [ngClass]="{'-translate-x-full': !isSidebarOpen && isMobile, 'translate-x-0': isSidebarOpen && isMobile, 'w-64': isSidebarOpen && !isMobile, 'w-20': !isSidebarOpen && !isMobile}"
      class="fixed inset-y-0 left-0 z-30 bg-bg-main border-r border-primary/30 lg:static transform transition-all duration-300 ease-in-out flex flex-col h-[calc(100vh-64px)] top-16 lg:top-0">


      <nav class="flex-1 py-4 px-2 space-y-2 bg-bg-main overflow-y-auto scrollbar-hide">
        <ng-container *ngFor="let item of navItems">
          <a [routerLink]="item.link" [queryParams]="item.queryParams" routerLinkActive="selected"
            #rl="routerLinkActive" (click)="closeSidebar()"
            class="flex items-center gap-2 p-2 rounded-xl text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-all group relative"
            [ngClass]="{'justify-center': !isSidebarOpen && !isMobile}">

            <div
              class="w-10 h-10 flex items-center justify-center flex-shrink-0 transition-all rounded-xl border border-transparent"
              [ngClass]="rl.isActive ? (item.bgColor + ' border-primary/10 shadow-sm') : 'bg-transparent'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-colors" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" [ngClass]="rl.isActive ? item.color : 'text-gray-400 group-hover:text-gray-600'">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" [attr.d]="item.svgPath" />
              </svg>
            </div>

            <span class="text-sm font-bold truncate transition-all duration-300 overflow-hidden"
              [ngClass]="{'w-0 opacity-0 hidden': !isSidebarOpen && !isMobile, 'w-auto opacity-100': isSidebarOpen || isMobile, 'text-main': rl.isActive, 'text-gray-500': !rl.isActive}">
              {{ item.label }}
            </span>

            <!-- Tooltip (only when collapsed) -->
            <div *ngIf="!isSidebarOpen && !isMobile"
              class="absolute left-full ml-4 px-3 py-2 bg-gray-900 text-white text-[10px] font-bold rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl pointer-events-none">
              {{ item.label }}
              <div class="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-gray-900">
              </div>
            </div>
          </a>
        </ng-container>
      </nav>

      <!-- Bottom actions Removed from sidebar as they are in dropdown -->
    </aside>

    <!-- Mobile Backdrop -->
    <div *ngIf="isSidebarOpen && isMobile" (click)="closeSidebar()"
      class="fixed inset-0 bg-black/40 z-20 lg:hidden backdrop-blur-sm animate-fade-in"></div>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-y-auto overflow-x-hidden h-[calc(100vh-64px)] p-4 sm:p-6 lg:p-10 w-full">
      <div class="mx-auto max-w-7xl">
        <router-outlet></router-outlet>
      </div>
    </main>
  </div>

  <!-- Logout Confirmation -->
  <app-confirmation-modal *ngIf="isLogoutModalOpen" [isOpen]="isLogoutModalOpen" title="Se dÃ©connecter ?"
    message="ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter ?" confirmText="DÃ©connexion" cancelText="Annuler" type="danger"
    (confirm)="confirmLogout()" (cancel)="closeLogoutModal()">
  </app-confirmation-modal>
</div>

<app-notification-permission-prompt></app-notification-permission-prompt>